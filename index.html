<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#050916" />
    <meta name="color-scheme" content="dark" />
    <title>Water Tracker • Deep Ocean Cyberpunk</title>

    <!-- Google Font (единственная внешняя зависимость) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Rajdhani:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg0: #03040a;
        --bg1: #050916;
        --bg2: #07112a;

        --glass: rgba(10, 18, 40, 0.4);
        --glass2: rgba(10, 18, 40, 0.22);
        --stroke: rgba(120, 245, 255, 0.18);
        --stroke2: rgba(120, 245, 255, 0.1);

        --cyan: #62f6ff;
        --cyan2: #1ad7ff;
        --cyan3: #00a9ff;

        --txt: rgba(232, 251, 255, 0.92);
        --muted: rgba(232, 251, 255, 0.62);

        --shadow: 0 24px 80px rgba(0, 0, 0, 0.55);
        --glow: 0 0 18px rgba(98, 246, 255, 0.4),
          0 0 52px rgba(26, 215, 255, 0.18);

        --r: 22px;
        --r2: 28px;

        --p: 0; /* 0..100 (уровень для визуализации) */
        --parx: 0px; /* параллакс X */
        --pary: 0px; /* параллакс Y */
        --tilt: 0deg; /* микро-поворот */
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: "Rajdhani", system-ui, -apple-system, Segoe UI, Roboto,
          Arial, sans-serif;
        color: var(--txt);
        background: radial-gradient(
            1200px 900px at 50% 10%,
            rgba(98, 246, 255, 0.08),
            transparent 65%
          ),
          radial-gradient(
            900px 700px at 20% 80%,
            rgba(26, 215, 255, 0.05),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg0), var(--bg1) 40%, var(--bg2));
        overflow: hidden;
        overscroll-behavior: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
      }

      /* ===== Live Background (Deep Ocean Cyberpunk) ===== */
      .bg {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        transform: translate3d(var(--parx), var(--pary), 0) rotate(var(--tilt));
        transform-origin: 50% 50%;
        will-change: transform;
      }
      .bg::before,
      .bg::after {
        content: "";
        position: absolute;
        inset: -12%;
        filter: blur(10px);
        opacity: 0.95;
      }

      /* base flow */
      .bg::before {
        background: radial-gradient(
            900px 700px at 30% 20%,
            rgba(98, 246, 255, 0.16),
            transparent 60%
          ),
          radial-gradient(
            700px 550px at 70% 70%,
            rgba(26, 215, 255, 0.12),
            transparent 58%
          ),
          radial-gradient(
            1000px 800px at 40% 90%,
            rgba(0, 169, 255, 0.1),
            transparent 62%
          ),
          conic-gradient(
            from 240deg at 50% 50%,
            rgba(98, 246, 255, 0.14),
            rgba(0, 0, 0, 0),
            rgba(26, 215, 255, 0.1),
            rgba(0, 0, 0, 0),
            rgba(0, 169, 255, 0.1),
            rgba(0, 0, 0, 0),
            rgba(98, 246, 255, 0.12)
          );
        animation: drift 14s ease-in-out infinite;
        mix-blend-mode: screen;
      }

      /* caustics-ish shimmer */
      .bg::after {
        background: repeating-radial-gradient(
            circle at 20% 30%,
            rgba(98, 246, 255, 0.06) 0 8px,
            rgba(0, 0, 0, 0) 10px 24px
          ),
          repeating-radial-gradient(
            circle at 80% 70%,
            rgba(26, 215, 255, 0.05) 0 6px,
            rgba(0, 0, 0, 0) 8px 22px
          ),
          radial-gradient(
            1200px 900px at 50% 50%,
            rgba(98, 246, 255, 0.1),
            transparent 68%
          );
        opacity: 0.25;
        animation: shimmer 10s linear infinite;
        transform: translate3d(
          calc(var(--parx) * -0.25),
          calc(var(--pary) * -0.25),
          0
        );
      }

      @keyframes drift {
        0% {
          transform: translate3d(-1.5%, -1.2%, 0) scale(1.02);
        }
        50% {
          transform: translate3d(1.8%, 1%, 0) scale(1.04);
        }
        100% {
          transform: translate3d(-1.5%, -1.2%, 0) scale(1.02);
        }
      }
      @keyframes shimmer {
        0% {
          background-position: 0 0, 0 0, 0 0;
        }
        100% {
          background-position: 420px 260px, -360px -220px, 0 0;
        }
      }

      /* ===== App Layout ===== */
      .app {
        position: relative;
        z-index: 1;
        min-height: 100dvh;
        display: grid;
        grid-template-rows: auto 1fr auto;
        padding: max(16px, env(safe-area-inset-top)) 16px
          max(16px, env(safe-area-inset-bottom));
        gap: 14px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 8px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0.95;
      }
      .brand__mark {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background: radial-gradient(
            12px 12px at 30% 30%,
            rgba(98, 246, 255, 0.65),
            rgba(98, 246, 255, 0.12) 55%,
            rgba(0, 0, 0, 0) 70%
          ),
          linear-gradient(
            135deg,
            rgba(98, 246, 255, 0.25),
            rgba(10, 18, 40, 0.1)
          );
        border: 1px solid var(--stroke);
        box-shadow: var(--glow);
        position: relative;
        overflow: hidden;
      }
      .brand__mark::after {
        content: "";
        position: absolute;
        inset: -30%;
        background: conic-gradient(
          from 180deg,
          rgba(98, 246, 255, 0),
          rgba(98, 246, 255, 0.18),
          rgba(98, 246, 255, 0)
        );
        animation: spin 4.8s linear infinite;
        opacity: 0.75;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .brand__name {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 0.06em;
        font-weight: 700;
        font-size: 14px;
        color: rgba(232, 251, 255, 0.88);
        text-transform: uppercase;
        line-height: 1.1;
      }
      .brand__sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
        letter-spacing: 0.02em;
      }

      .hint {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(10, 18, 40, 0.22);
        border: 1px solid rgba(120, 245, 255, 0.12);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        color: rgba(232, 251, 255, 0.7);
        font-size: 12px;
        box-shadow: 0 10px 32px rgba(0, 0, 0, 0.35);
      }
      .hint svg {
        opacity: 0.8;
      }

      .center {
        display: grid;
        place-items: center;
        padding: 10px 0;
      }

      /* ===== Gauge (Glass + Water) ===== */
      .gauge-wrap {
        width: min(420px, 100%);
        display: grid;
        place-items: center;
        gap: 18px;
      }

      .gauge {
        width: min(320px, 84vw);
        aspect-ratio: 1 / 1;
        position: relative;
        border-radius: 999px;
        filter: drop-shadow(0 18px 60px rgba(0, 0, 0, 0.55));
      }

      .ring {
        position: absolute;
        inset: 0;
        border-radius: 999px;
        background: radial-gradient(
            circle at 50% 50%,
            rgba(0, 0, 0, 0) 56%,
            rgba(0, 0, 0, 0.55) 72%,
            rgba(0, 0, 0, 0) 78%
          ),
          conic-gradient(
            from -90deg,
            rgba(98, 246, 255, 0.95) calc(var(--p) * 1%),
            rgba(120, 245, 255, 0.12) 0
          );
        mask: radial-gradient(circle at 50% 50%, transparent 61%, #000 62%);
        -webkit-mask: radial-gradient(
          circle at 50% 50%,
          transparent 61%,
          #000 62%
        );
        box-shadow: var(--glow);
        opacity: 0.95;
        animation: ringPulse 3.6s ease-in-out infinite;
      }
      @keyframes ringPulse {
        0%,
        100% {
          filter: saturate(1.05) brightness(1);
        }
        50% {
          filter: saturate(1.25) brightness(1.08);
        }
      }

      .glass {
        position: absolute;
        inset: 14px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          rgba(10, 18, 40, 0.45),
          rgba(10, 18, 40, 0.2)
        );
        border: 1px solid rgba(120, 245, 255, 0.16);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -10px 30px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        overflow: hidden;
      }

      .water {
        position: absolute;
        inset: 0;
        top: calc((100 - var(--p)) * 1%);
        transition: top 420ms cubic-bezier(0.2, 0.85, 0.2, 1);
        background: radial-gradient(
            240px 160px at 30% 20%,
            rgba(98, 246, 255, 0.4),
            rgba(98, 246, 255, 0.12) 55%,
            rgba(0, 0, 0, 0) 72%
          ),
          linear-gradient(
            180deg,
            rgba(98, 246, 255, 0.14),
            rgba(26, 215, 255, 0.08)
          );
        filter: saturate(1.1);
      }

      .wave {
        position: absolute;
        inset: -30% -20% -30% -20%;
        opacity: 0.85;
        background: radial-gradient(
            18px 12px at 10% 30%,
            rgba(98, 246, 255, 0.35),
            rgba(0, 0, 0, 0) 70%
          ),
          radial-gradient(
            18px 12px at 55% 60%,
            rgba(26, 215, 255, 0.26),
            rgba(0, 0, 0, 0) 70%
          ),
          radial-gradient(
            18px 12px at 85% 40%,
            rgba(0, 169, 255, 0.22),
            rgba(0, 0, 0, 0) 70%
          ),
          repeating-linear-gradient(
            90deg,
            rgba(98, 246, 255, 0.1) 0 26px,
            rgba(0, 0, 0, 0) 26px 54px
          );
        transform: translate3d(0, 0, 0);
        mix-blend-mode: screen;
        animation: waves 3.8s linear infinite;
      }
      .wave.w2 {
        opacity: 0.55;
        filter: blur(1.5px);
        animation-duration: 5.6s;
        animation-direction: reverse;
      }
      @keyframes waves {
        0% {
          transform: translate3d(-4%, 2%, 0) rotate(-1deg);
        }
        100% {
          transform: translate3d(4%, -2%, 0) rotate(1deg);
        }
      }

      .gauge-content {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        text-align: center;
        padding: 42px 18px;
      }

      .percent {
        font-family: "Orbitron", sans-serif;
        font-weight: 800;
        letter-spacing: 0.04em;
        font-size: clamp(44px, 10vw, 64px);
        line-height: 1;
        text-shadow: 0 0 26px rgba(98, 246, 255, 0.28);
      }
      .amount {
        margin-top: 10px;
        font-size: 15px;
        color: rgba(232, 251, 255, 0.74);
        letter-spacing: 0.02em;
      }
      .goal-note {
        margin-top: 8px;
        font-size: 12px;
        color: rgba(232, 251, 255, 0.52);
      }

      .streak-info {
        margin-top: 16px;
        text-align: center;
        font-size: 14px;
        color: var(--muted);
      }
      .streak-info strong {
        color: var(--cyan);
      }

      /* ===== Controls ===== */
      .controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 14px;
        margin-top: 4px;
      }

      .btn {
        border: 1px solid var(--stroke);
        background: linear-gradient(
          180deg,
          rgba(10, 18, 40, 0.55),
          rgba(10, 18, 40, 0.26)
        );
        color: var(--txt);
        border-radius: 999px;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        box-shadow: var(--shadow), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        cursor: pointer;
        transition: transform 120ms ease, border-color 180ms ease,
          box-shadow 240ms ease, background 240ms ease;
        outline: none;
        -webkit-user-select: none;
        user-select: none;
      }
      .btn:active {
        transform: translateY(1px) scale(0.99);
      }
      .btn:focus-visible {
        box-shadow: var(--shadow), 0 0 0 2px rgba(98, 246, 255, 0.25),
          var(--glow);
        border-color: rgba(98, 246, 255, 0.35);
      }

      .btn--big {
        width: 86px;
        height: 86px;
        border-color: rgba(98, 246, 255, 0.28);
        box-shadow: var(--shadow), var(--glow),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
      }
      .btn--big::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: conic-gradient(
          from 0deg,
          rgba(98, 246, 255, 0),
          rgba(98, 246, 255, 0.14),
          rgba(98, 246, 255, 0),
          rgba(26, 215, 255, 0.1),
          rgba(98, 246, 255, 0)
        );
        animation: spin 5.5s linear infinite;
        opacity: 0.95;
      }
      .btn--big svg {
        position: relative;
        z-index: 1;
        filter: drop-shadow(0 0 14px rgba(98, 246, 255, 0.35));
      }

      .btn--small {
        width: 56px;
        height: 56px;
        border-color: rgba(120, 245, 255, 0.18);
        opacity: 0.92;
      }
      .btn--small:hover {
        border-color: rgba(98, 246, 255, 0.3);
      }

      /* ===== Bottom Nav (subtle) ===== */
      .bottom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 6px 4px;
      }
      .navbtn {
        width: 52px;
        height: 44px;
        border-radius: 16px;
        border: 1px solid rgba(120, 245, 255, 0.14);
        background: rgba(10, 18, 40, 0.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 120ms ease, border-color 200ms ease,
          background 200ms ease, box-shadow 240ms ease;
        outline: none;
      }
      .navbtn svg {
        opacity: 0.86;
      }
      .navbtn:active {
        transform: translateY(1px);
      }
      .navbtn:focus-visible {
        border-color: rgba(98, 246, 255, 0.3);
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.35),
          0 0 0 2px rgba(98, 246, 255, 0.22);
      }

      /* ===== Modals ===== */
      .modal {
        position: fixed;
        inset: 0;
        z-index: 10;
        display: grid;
        place-items: center;
        padding: 18px;
        background: rgba(2, 4, 10, 0.55);
        opacity: 0;
        pointer-events: none;
        transition: opacity 220ms ease;
      }
      .modal.is-open {
        opacity: 1;
        pointer-events: auto;
      }
      .sheet {
        width: min(520px, 100%);
        border-radius: var(--r2);
        background: linear-gradient(
          180deg,
          rgba(10, 18, 40, 0.55),
          rgba(10, 18, 40, 0.25)
        );
        border: 1px solid rgba(120, 245, 255, 0.18);
        box-shadow: 0 30px 120px rgba(0, 0, 0, 0.7), var(--glow);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        overflow: hidden;
        transform: translateY(10px) scale(0.985);
        transition: transform 240ms cubic-bezier(0.2, 0.85, 0.2, 1);
      }
      .modal.is-open .sheet {
        transform: translateY(0) scale(1);
      }

      .sheet__head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(120, 245, 255, 0.1);
        background: rgba(10, 18, 40, 0.2);
      }
      .sheet__title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: "Orbitron", sans-serif;
        letter-spacing: 0.05em;
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        color: rgba(232, 251, 255, 0.88);
      }
      .close {
        width: 42px;
        height: 38px;
        border-radius: 14px;
        border: 1px solid rgba(120, 245, 255, 0.14);
        background: rgba(10, 18, 40, 0.2);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 120ms ease, border-color 200ms ease;
        outline: none;
      }
      .close:active {
        transform: translateY(1px);
      }
      .close:focus-visible {
        border-color: rgba(98, 246, 255, 0.3);
      }

      .sheet__body {
        padding: 16px;
        display: grid;
        gap: 14px;
      }

      .field {
        display: grid;
        gap: 8px;
      }
      .label {
        color: rgba(232, 251, 255, 0.78);
        font-weight: 600;
        letter-spacing: 0.02em;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .label small {
        font-weight: 600;
        color: rgba(232, 251, 255, 0.52);
      }

      .input {
        width: 100%;
        border-radius: 16px;
        border: 1px solid rgba(120, 245, 255, 0.14);
        background: rgba(10, 18, 40, 0.22);
        color: rgba(232, 251, 255, 0.92);
        padding: 12px 12px;
        font-size: 16px;
        outline: none;
        transition: border-color 200ms ease, box-shadow 220ms ease;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      }
      .input:focus {
        border-color: rgba(98, 246, 255, 0.3);
        box-shadow: 0 0 0 2px rgba(98, 246, 255, 0.16);
      }
      input[type="number"] {
        appearance: textfield;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 420px) {
        .row {
          grid-template-columns: 1fr;
        }
      }

      .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
        margin-top: 4px;
      }
      .btnline {
        padding: 10px 14px;
        border-radius: 16px;
        font-weight: 700;
        letter-spacing: 0.02em;
        font-size: 14px;
      }
      .btnline.primary {
        border-color: rgba(98, 246, 255, 0.3);
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45),
          0 0 24px rgba(98, 246, 255, 0.24);
      }
      .btnline.danger {
        border-color: rgba(98, 246, 255, 0.14);
        opacity: 0.95;
      }

      .divider {
        height: 1px;
        background: rgba(120, 245, 255, 0.1);
        margin: 4px 0;
      }

      /* ===== Stats list ===== */
      .stats {
        display: grid;
        gap: 10px;
        max-height: 50vh;
        overflow-y: auto;
        padding-right: 6px;
      }
      .stats::-webkit-scrollbar {
        width: 4px;
      }
      .stats::-webkit-scrollbar-thumb {
        background: rgba(120, 245, 255, 0.18);
        border-radius: 999px;
      }
      .stats::-webkit-scrollbar-track {
        background: transparent;
      }
      .statrow {
        display: grid;
        grid-template-columns: 84px 1fr;
        gap: 12px;
        align-items: center;
        padding: 10px 10px;
        border-radius: 18px;
        border: 1px solid rgba(120, 245, 255, 0.12);
        background: rgba(10, 18, 40, 0.16);
      }
      .date {
        font-family: "Orbitron", sans-serif;
        font-size: 11px;
        letter-spacing: 0.05em;
        color: rgba(232, 251, 255, 0.7);
        text-transform: uppercase;
        line-height: 1.25;
      }
      .date b {
        display: block;
        font-size: 12px;
        color: rgba(232, 251, 255, 0.92);
        margin-top: 2px;
      }
      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(120, 245, 255, 0.08);
        border: 1px solid rgba(120, 245, 255, 0.1);
        overflow: hidden;
        position: relative;
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          rgba(98, 246, 255, 0.85),
          rgba(0, 169, 255, 0.55)
        );
        box-shadow: 0 0 18px rgba(98, 246, 255, 0.25);
        border-radius: 999px;
        transition: width 520ms cubic-bezier(0.2, 0.85, 0.2, 1);
      }
      .meta {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 8px;
        color: rgba(232, 251, 255, 0.62);
        font-size: 13px;
      }
      .meta strong {
        color: rgba(232, 251, 255, 0.88);
        font-weight: 700;
      }

      /* subtle footer safe area */
      .safe {
        height: max(0px, env(safe-area-inset-bottom));
      }

      /* ===== Custom Add Modal ===== */
      .custom-add {
        display: grid;
        gap: 12px;
      }
      .custom-add .input {
        text-align: center;
      }

      /* reduce motion */
      @media (prefers-reduced-motion: reduce) {
        .bg::before,
        .bg::after,
        .ring,
        .btn--big::before,
        .wave {
          animation: none !important;
        }
        .water,
        .bar > i,
        .modal,
        .sheet {
          transition: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="bg" aria-hidden="true"></div>

    <div class="app">
      <div class="topbar">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true"></div>
          <div>
            <div class="brand__name">Water Tracker</div>
            <div class="brand__sub" id="subline">Deep Ocean Cyberpunk</div>
          </div>
        </div>

        <div class="hint" id="hint">
          <!-- droplet icon -->
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M12 2C12 2 6 9.2 6 13.8C6 17.8 8.9 21 12 21C15.1 21 18 17.8 18 13.8C18 9.2 12 2 12 2Z"
              stroke="rgba(98,246,255,.85)"
              stroke-width="1.6"
            />
            <path
              d="M9.4 14.1C9.6 16.2 10.9 17.6 12.6 18.1"
              stroke="rgba(98,246,255,.55)"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
          <span id="hintText">+ добавляет стакан</span>
        </div>
      </div>

      <div class="center">
        <div class="gauge-wrap">
          <div class="gauge" aria-label="Прогресс гидратации">
            <div class="ring" aria-hidden="true"></div>
            <div class="glass">
              <div class="water" id="water" aria-hidden="true">
                <div class="wave"></div>
                <div class="wave w2"></div>
              </div>
            </div>

            <div class="gauge-content">
              <div class="percent" id="percent">0%</div>
              <div class="amount" id="amount">0 / 0 ml</div>
              <div class="goal-note" id="goalNote">
                Цель: 0 ml • Стакан: 250 ml
              </div>
            </div>
          </div>

          <div class="streak-info" id="streakInfo">
            Серия: 0 дней • Всего дней: 1
          </div>

          <div class="controls" aria-label="Управление">
            <button
              class="btn btn--small"
              id="minusBtn"
              type="button"
              aria-label="Убавить стакан"
            >
              <!-- minus icon -->
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                aria-hidden="true"
              >
                <path
                  d="M6.5 12H17.5"
                  stroke="rgba(232,251,255,.92)"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
            </button>

            <button
              class="btn btn--big"
              id="plusBtn"
              type="button"
              aria-label="Добавить стакан"
            >
              <!-- plus icon -->
              <svg
                width="28"
                height="28"
                viewBox="0 0 24 24"
                fill="none"
                aria-hidden="true"
              >
                <path
                  d="M12 6.5V17.5"
                  stroke="rgba(232,251,255,.92)"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M6.5 12H17.5"
                  stroke="rgba(232,251,255,.92)"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
            </button>

            <button
              class="btn btn--small"
              id="customBtn"
              type="button"
              aria-label="Добавить кастомное количество"
            >
              <!-- edit icon -->
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                aria-hidden="true"
              >
                <path
                  d="M4 20h16"
                  stroke="rgba(232,251,255,.92)"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M16.5 3.5l4 4-9 9-4 1 1-4 9-9z"
                  stroke="rgba(98,246,255,.85)"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="bottom" aria-label="Навигация">
        <button
          class="navbtn"
          id="settingsBtn"
          type="button"
          aria-label="Настройки"
        >
          <!-- gear icon -->
          <svg
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z"
              stroke="rgba(232,251,255,.88)"
              stroke-width="1.6"
            />
            <path
              d="M19.2 12a7.2 7.2 0 0 0-.08-1l2-1.44-1.8-3.12-2.36.82a7.2 7.2 0 0 0-1.72-1l-.36-2.48H10.2l-.36 2.48a7.2 7.2 0 0 0-1.72 1l-2.36-.82-1.8 3.12 2 1.44a7.2 7.2 0 0 0 0 2l-2 1.44 1.8 3.12 2.36-.82c.54.4 1.12.74 1.72 1l.36 2.48h3.6l.36-2.48c.6-.26 1.18-.6 1.72-1l2.36.82 1.8-3.12-2-1.44c.05-.33.08-.66.08-1Z"
              stroke="rgba(98,246,255,.55)"
              stroke-width="1.2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>

        <div class="safe" aria-hidden="true"></div>

        <button
          class="navbtn"
          id="statsBtn"
          type="button"
          aria-label="Статистика"
        >
          <!-- chart icon -->
          <svg
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M5.5 18.5V5.5"
              stroke="rgba(232,251,255,.55)"
              stroke-width="1.6"
              stroke-linecap="round"
            />
            <path
              d="M5.5 18.5H18.5"
              stroke="rgba(232,251,255,.55)"
              stroke-width="1.6"
              stroke-linecap="round"
            />
            <path
              d="M8.2 15.2l3-3 2.2 2.2 4.2-5"
              stroke="rgba(98,246,255,.85)"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M8.2 15.2h0"
              stroke="rgba(98,246,255,.85)"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M11.2 12.2h0"
              stroke="rgba(98,246,255,.85)"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M13.4 14.4h0"
              stroke="rgba(98,246,255,.85)"
              stroke-width="4"
              stroke-linecap="round"
            />
            <path
              d="M17.6 9.4h0"
              stroke="rgba(98,246,255,.85)"
              stroke-width="4"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      class="modal"
      id="settingsModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="settingsTitle"
    >
      <div class="sheet" role="document">
        <div class="sheet__head">
          <div class="sheet__title" id="settingsTitle">
            <!-- sliders icon -->
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M4 7h10"
                stroke="rgba(98,246,255,.85)"
                stroke-width="1.8"
                stroke-linecap="round"
              />
              <path
                d="M18 7h2"
                stroke="rgba(232,251,255,.72)"
                stroke-width="1.8"
                stroke-linecap="round"
              />
              <path
                d="M4 17h2"
                stroke="rgba(232,251,255,.72)"
                stroke-width="1.8"
                stroke-linecap="round"
              />
              <path
                d="M10 17h10"
                stroke="rgba(98,246,255,.85)"
                stroke-width="1.8"
                stroke-linecap="round"
              />
              <path
                d="M14 7a2 2 0 1 0 0 .01"
                stroke="rgba(98,246,255,.40)"
                stroke-width="1.6"
                fill="none"
              />
              <path
                d="M8 17a2 2 0 1 0 0 .01"
                stroke="rgba(98,246,255,.40)"
                stroke-width="1.6"
                fill="none"
              />
            </svg>
            Настройки
          </div>

          <button
            class="close"
            id="settingsClose"
            type="button"
            aria-label="Закрыть настройки"
          >
            <!-- X icon -->
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M7 7l10 10"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M17 7L7 17"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div class="sheet__body">
          <div class="row">
            <div class="field">
              <div class="label">
                <span>Вес (кг)</span>
                <small>цель = вес × 35 мл</small>
              </div>
              <input
                class="input"
                id="weightInput"
                type="number"
                inputmode="decimal"
                min="20"
                max="250"
                step="0.1"
              />
            </div>

            <div class="field">
              <div class="label">
                <span>Объём стакана (мл)</span>
                <small>по умолчанию 250</small>
              </div>
              <input
                class="input"
                id="glassInput"
                type="number"
                inputmode="numeric"
                min="50"
                max="2000"
                step="10"
              />
            </div>
          </div>

          <div class="field">
            <div class="label">
              <span>Ручная цель (мл)</span>
              <small>перезапишет расчёт по весу</small>
            </div>
            <input
              class="input"
              id="customGoalInput"
              type="number"
              inputmode="numeric"
              min="500"
              max="10000"
              step="100"
            />
          </div>

          <div class="divider"></div>

          <div class="field">
            <div class="label">
              <span>Текущая цель</span>
              <small id="settingsGoal">0 мл/день</small>
            </div>
            <div
              style="
                color: rgba(232, 251, 255, 0.62);
                font-size: 13px;
                line-height: 1.45;
              "
            >
              Данные сохраняются локально (LocalStorage). При смене дня счётчик
              «сегодня» сбрасывается, а результат за вчера автоматически
              попадает в историю. Статистика хранится до 30 дней.
            </div>
          </div>

          <div class="actions">
            <button class="btn btnline" id="settingsCancel" type="button">
              Отмена
            </button>
            <button class="btn btnline primary" id="settingsSave" type="button">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Modal -->
    <div
      class="modal"
      id="statsModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="statsTitle"
    >
      <div class="sheet" role="document">
        <div class="sheet__head">
          <div class="sheet__title" id="statsTitle">
            <!-- histogram icon -->
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M6 19V10"
                stroke="rgba(98,246,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M12 19V6"
                stroke="rgba(232,251,255,.78)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M18 19v-8"
                stroke="rgba(98,246,255,.55)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M5 19h14"
                stroke="rgba(232,251,255,.48)"
                stroke-width="1.6"
                stroke-linecap="round"
              />
            </svg>
            Статистика (до 30 дней)
          </div>

          <button
            class="close"
            id="statsClose"
            type="button"
            aria-label="Закрыть статистику"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M7 7l10 10"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M17 7L7 17"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div class="sheet__body">
          <div class="stats" id="statsList"></div>

          <div class="divider"></div>

          <div class="field">
            <div class="label">
              <span>Сводка</span>
              <small id="statsSummary">—</small>
            </div>
          </div>

          <div class="actions" style="justify-content: space-between">
            <button class="btn btnline danger" id="resetToday" type="button">
              Сбросить за сегодня
            </button>
            <button class="btn btnline danger" id="resetAll" type="button">
              Сбросить всё
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Add Modal -->
    <div
      class="modal"
      id="customModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="customTitle"
    >
      <div class="sheet" role="document">
        <div class="sheet__head">
          <div class="sheet__title" id="customTitle">
            <!-- plus icon -->
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M12 6.5V17.5"
                stroke="rgba(98,246,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M6.5 12H17.5"
                stroke="rgba(98,246,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
            Добавить воду
          </div>

          <button
            class="close"
            id="customClose"
            type="button"
            aria-label="Закрыть"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M7 7l10 10"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M17 7L7 17"
                stroke="rgba(232,251,255,.85)"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div class="sheet__body">
          <div class="custom-add">
            <div class="field">
              <div class="label">
                <span>Количество (мл)</span>
                <small>минимум 50 мл</small>
              </div>
              <input
                class="input"
                id="customMlInput"
                type="number"
                inputmode="numeric"
                min="50"
                step="10"
                placeholder="Введите мл"
              />
            </div>
          </div>

          <div class="actions">
            <button class="btn btnline" id="customCancel" type="button">
              Отмена
            </button>
            <button class="btn btnline primary" id="customSave" type="button">
              Добавить
            </button>
          </div>
        </div>
      </div>
    </div>

<script>
  (() => {
    "use strict";

    // ВАЖНО: ключ НЕ меняем — данные сохранятся.
    const STORAGE_KEY = "water_tracker_deep_ocean_v2";
    const OLD_STORAGE_KEY = "water_tracker_deep_ocean_v1";

    const $ = (sel, root = document) => root.querySelector(sel);

    const els = {
      percent: $("#percent"),
      amount: $("#amount"),
      goalNote: $("#goalNote"),
      hintText: $("#hintText"),
      streakInfo: $("#streakInfo"),

      plusBtn: $("#plusBtn"),
      minusBtn: $("#minusBtn"),
      customBtn: $("#customBtn"),

      settingsBtn: $("#settingsBtn"),
      statsBtn: $("#statsBtn"),

      settingsModal: $("#settingsModal"),
      statsModal: $("#statsModal"),
      customModal: $("#customModal"),

      settingsClose: $("#settingsClose"),
      statsClose: $("#statsClose"),
      customClose: $("#customClose"),
      settingsCancel: $("#settingsCancel"),
      settingsSave: $("#settingsSave"),
      customCancel: $("#customCancel"),
      customSave: $("#customSave"),

      weightInput: $("#weightInput"),
      glassInput: $("#glassInput"),
      customGoalInput: $("#customGoalInput"),
      settingsGoal: $("#settingsGoal"),

      statsList: $("#statsList"),
      statsSummary: $("#statsSummary"),

      resetToday: $("#resetToday"),
      resetAll: $("#resetAll"),

      customMlInput: $("#customMlInput"),
    };

    const pad2 = (n) => String(n).padStart(2, "0");
    const ISO_RE = /^\d{4}-\d{2}-\d{2}$/;
    const isISODate = (s) => typeof s === "string" && ISO_RE.test(s);

    const toISODateLocal = (d) =>
      `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;

    // Полдень — чтобы DST/переводы часов не ломали подсчёт дней
    const dateFromISO = (iso) => {
      const [y, m, day] = iso.split("-").map(Number);
      return new Date(y, m - 1, day, 12, 0, 0, 0);
    };

    const MS_DAY = 24 * 60 * 60 * 1000;

    const diffDays = (isoA, isoB) => {
      if (!isISODate(isoA) || !isISODate(isoB)) return 0;
      return Math.round((dateFromISO(isoB) - dateFromISO(isoA)) / MS_DAY);
    };

    const addDays = (isoDate, delta) => {
      const d = dateFromISO(isoDate);
      d.setDate(d.getDate() + delta);
      return toISODateLocal(d);
    };

    const daysBetweenInclusive = (isoA, isoB) => {
      if (!isISODate(isoA) || !isISODate(isoB)) return 1;
      const d = Math.round((dateFromISO(isoB) - dateFromISO(isoA)) / MS_DAY);
      return d >= 0 ? d + 1 : 1;
    };

    const weekdayShort = (isoDate) => {
      const d = dateFromISO(isoDate);
      return d.toLocaleDateString("ru-RU", { weekday: "short" }).replace(".", "");
    };

    const prettyDate = (isoDate) => {
      const d = dateFromISO(isoDate);
      return d.toLocaleDateString("ru-RU", { day: "2-digit", month: "2-digit" });
    };

    const clamp = (v, a, b) => Math.min(b, Math.max(a, v));

    const calcGoalMl = (weightKg, customGoal = 0) => {
      const cg = Number(customGoal);
      if (Number.isFinite(cg) && cg > 0) return Math.round(cg);

      const w = Number(weightKg);
      if (!Number.isFinite(w) || w <= 0) return 0;
      return Math.round(w * 35);
    };

    const defaults = () => {
      const today = toISODateLocal(new Date());
      return {
        firstDate: today,
        weightKg: 70,
        glassMl: 250,
        customGoal: 0,
        todayMl: 0,
        lastDate: today,
        history: [], // [{date:'YYYY-MM-DD', ml:number, goalMl:number}]
      };
    };

    const dedupeHistoryByDate = (arr) => {
      const map = new Map();
      for (const item of arr) {
        if (item && isISODate(item.date)) map.set(item.date, item);
      }
      return Array.from(map.values()).sort((a, b) => a.date.localeCompare(b.date));
    };

    const normalizeFirstDate = () => {
      const today = toISODateLocal(new Date());

      let first = isISODate(state.firstDate)
        ? state.firstDate
        : isISODate(state.lastDate)
        ? state.lastDate
        : today;

      if (Array.isArray(state.history) && state.history.length) {
        const oldest = state.history
          .map((x) => x.date)
          .filter(isISODate)
          .sort()[0];
        if (oldest && oldest < first) first = oldest;
      }

      const last = isISODate(state.lastDate) ? state.lastDate : today;
      if (first > last) first = last;

      state.firstDate = first;
    };

    const load = () => {
      // Migration v1 -> v2 (если v2 ещё нет)
      if (!localStorage.getItem(STORAGE_KEY)) {
        const oldRaw = localStorage.getItem(OLD_STORAGE_KEY);
        if (oldRaw) {
          try {
            const oldParsed = JSON.parse(oldRaw);
            const d = defaults();
            const migrated = {
              ...d,
              weightKg: Number.isFinite(+oldParsed.weightKg) ? +oldParsed.weightKg : d.weightKg,
              glassMl: Number.isFinite(+oldParsed.glassMl) ? Math.round(+oldParsed.glassMl) : d.glassMl,
              customGoal: Number.isFinite(+oldParsed.customGoal) ? Math.round(+oldParsed.customGoal) : d.customGoal,
              todayMl: Number.isFinite(+oldParsed.todayMl) ? Math.round(+oldParsed.todayMl) : d.todayMl,
              lastDate: isISODate(oldParsed.lastDate) ? oldParsed.lastDate : d.lastDate,
              history: Array.isArray(oldParsed.history) ? oldParsed.history : d.history,
              firstDate: isISODate(oldParsed.firstDate) ? oldParsed.firstDate : d.firstDate,
            };

            migrated.history = migrated.history
              .filter((x) => x && isISODate(x.date))
              .map((x) => ({
                date: x.date,
                ml: Math.max(0, Math.round(+x.ml || 0)),
                goalMl: Math.max(0, Math.round(+x.goalMl || 0)),
              }));

            if (!isISODate(migrated.firstDate)) {
              migrated.firstDate = migrated.history.length
                ? migrated.history.slice().sort((a, b) => a.date.localeCompare(b.date))[0].date
                : migrated.lastDate;
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          } catch {
            // ignore
          }
        }
      }

      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaults();

        const parsed = JSON.parse(raw);
        const d = defaults();

        const safe = {
          firstDate: isISODate(parsed.firstDate) ? parsed.firstDate : d.firstDate,
          weightKg: Number.isFinite(+parsed.weightKg) ? +parsed.weightKg : d.weightKg,
          glassMl: Number.isFinite(+parsed.glassMl) ? Math.round(+parsed.glassMl) : d.glassMl,
          customGoal: Number.isFinite(+parsed.customGoal) ? Math.round(+parsed.customGoal) : d.customGoal,
          todayMl: Number.isFinite(+parsed.todayMl) ? Math.round(+parsed.todayMl) : d.todayMl,
          lastDate: isISODate(parsed.lastDate) ? parsed.lastDate : d.lastDate,
          history: Array.isArray(parsed.history) ? parsed.history : d.history,
        };

        safe.weightKg = clamp(safe.weightKg, 20, 250);
        safe.glassMl = clamp(safe.glassMl, 50, 2000);
        safe.customGoal = clamp(safe.customGoal, 0, 10000);
        safe.todayMl = Math.max(0, safe.todayMl);

        safe.history = safe.history
          .filter((x) => x && isISODate(x.date))
          .map((x) => ({
            date: x.date,
            ml: Math.max(0, Math.round(+x.ml || 0)),
            goalMl: Math.max(0, Math.round(+x.goalMl || 0)),
          }));

        safe.history = dedupeHistoryByDate(safe.history);

        return safe;
      } catch {
        return defaults();
      }
    };

    const save = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    // FIX: перенос дня с учётом пропущенных дней + защита от битых дат
    const ensureDayRollover = () => {
      const today = toISODateLocal(new Date());

      if (!isISODate(state.lastDate)) {
        state.lastDate = today;
        state.todayMl = 0;
        normalizeFirstDate();
        save();
        return;
      }

      const gap = diffDays(state.lastDate, today);

      // lastDate в будущем (битые данные) — выровняем
      if (gap < 0) {
        state.lastDate = today;
        state.todayMl = 0;
        normalizeFirstDate();
        save();
        return;
      }

      if (gap === 0) {
        normalizeFirstDate();
        return;
      }

      const goal = calcGoalMl(state.weightKg, state.customGoal);
      const map = new Map((state.history || []).map((x) => [x.date, x]));

      // записываем lastDate с фактическим todayMl
      map.set(state.lastDate, {
        date: state.lastDate,
        ml: state.todayMl,
        goalMl: goal,
      });

      // если пропущено несколько дней — добавим промежуточные (0 ml), если их нет
      for (let i = 1; i < gap; i++) {
        const date = addDays(state.lastDate, i);
        if (date === today) break;
        if (!map.has(date)) map.set(date, { date, ml: 0, goalMl: goal });
      }

      state.history = Array.from(map.values()).sort((a, b) => a.date.localeCompare(b.date));
      state.history = state.history.slice(-30);

      state.todayMl = 0;
      state.lastDate = today;

      normalizeFirstDate();
      save();
    };

    const haptic = (pattern = 10) => {
      if (navigator.vibrate) navigator.vibrate(pattern);
    };

    const setProgress = (percentVisual) => {
      document.documentElement.style.setProperty("--p", String(percentVisual));
    };

    const formatMl = (n) => `${Math.round(n)} ml`;

    const buildHistory = (maxDays = 30) => {
      const today = toISODateLocal(new Date());
      const goalToday = calcGoalMl(state.weightKg, state.customGoal);

      const map = new Map((state.history || []).map((x) => [x.date, x]));
      const days = [];

      // строго от старых к новым
      for (let i = maxDays - 1; i >= 0; i--) {
        const date = addDays(today, -i);
        if (date === today) {
          days.push({ date, ml: state.todayMl, goalMl: goalToday, isToday: true });
        } else {
          const entry = map.get(date);
          const entryGoal =
            entry && Number.isFinite(+entry.goalMl) && +entry.goalMl > 0 ? +entry.goalMl : goalToday;

          days.push({
            date,
            ml: entry ? entry.ml : 0,
            goalMl: entryGoal,
            isToday: false,
          });
        }
      }
      return days;
    };

    // FIX: серия считается корректно (без reverse-ошибки и без "вечных нулей")
    const calculateStreaks = () => {
      const days = buildHistory(); // oldest -> newest
      const isHit = (ml, goalMl) => goalMl > 0 && ml >= goalMl;

      // max streak
      let maxStreak = 0;
      let temp = 0;
      for (const d of days) {
        if (isHit(d.ml, d.goalMl)) {
          temp++;
          if (temp > maxStreak) maxStreak = temp;
        } else {
          temp = 0;
        }
      }

      // current streak: если сегодня не 100%, считаем подряд до вчера
      let currentStreak = 0;
      let idx = days.length - 1; // today
      if (idx < 0) return { currentStreak: 0, maxStreak: 0 };

      const todayHit = isHit(days[idx].ml, days[idx].goalMl);
      idx = todayHit ? idx : idx - 1;

      while (idx >= 0 && isHit(days[idx].ml, days[idx].goalMl)) {
        currentStreak++;
        idx--;
      }

      return { currentStreak, maxStreak };
    };

    const render = () => {
      ensureDayRollover();

      const goal = calcGoalMl(state.weightKg, state.customGoal);
      const current = state.todayMl;

      const rawPercent = goal > 0 ? Math.round((current / goal) * 100) : 0;
      const shownPercent = Number.isFinite(rawPercent) ? rawPercent : 0;
      const visualPercent = clamp(shownPercent, 0, 100);

      setProgress(visualPercent);

      els.percent.textContent = `${shownPercent}%`;
      els.amount.textContent = `${current} / ${goal} ml`;
      els.goalNote.textContent = `Цель: ${goal} ml • Стакан: ${state.glassMl} ml`;

      if (current === 0) els.hintText.textContent = "+ добавляет стакан, или укажите вручную";
      else if (shownPercent >= 100) els.hintText.textContent = "Цель достигнута! Можно + по желанию";
      else els.hintText.textContent = "+ / - стакан, или кастомное количество";

      const { currentStreak, maxStreak } = calculateStreaks();
      const totalDays = Math.max(1, daysBetweenInclusive(state.firstDate, state.lastDate));
      els.streakInfo.textContent = `Серия: ${currentStreak} дней (макс: ${maxStreak}) • Всего дней: ${totalDays}`;

      els.settingsGoal.textContent = `${goal} мл/день`;
    };

    const openModal = (modalEl) => {
      modalEl.classList.add("is-open");
      document.body.style.overflow = "hidden";
    };

    const closeModal = (modalEl) => {
      modalEl.classList.remove("is-open");
      document.body.style.overflow = "";
    };

    const isOpen = (modalEl) => modalEl.classList.contains("is-open");

    const onOverlayClickToClose = (modalEl, ev) => {
      if (ev.target === modalEl) closeModal(modalEl);
    };

    const renderStats = () => {
      ensureDayRollover();

      const days = buildHistory();
      els.statsList.innerHTML = "";

      let total = 0;
      let hits = 0;
      let totalDaysWithData = 0;

      for (const d of days) {
        const pct = d.goalMl > 0 ? Math.round((d.ml / d.goalMl) * 100) : 0;
        const w = clamp(pct, 0, 100);

        total += d.ml;
        if (d.ml > 0) totalDaysWithData++;
        if (pct >= 100) hits++;

        const row = document.createElement("div");
        row.className = "statrow";
        row.innerHTML = `
          <div class="date">
            ${d.isToday ? "сегодня" : weekdayShort(d.date)}
            <b>${prettyDate(d.date)}</b>
          </div>
          <div>
            <div class="bar" aria-hidden="true"><i style="width:${w}%"></i></div>
            <div class="meta">
              <span><strong>${d.ml}</strong> ml</span>
              <span>${formatMl(d.goalMl)} • ${pct}%</span>
            </div>
          </div>
        `;
        els.statsList.appendChild(row);
      }

      const avg = totalDaysWithData > 0 ? Math.round(total / totalDaysWithData) : 0;
      const { currentStreak, maxStreak } = calculateStreaks();
      els.statsSummary.textContent = `Итого: ${total} ml • Среднее: ${avg} ml/день • Дней 100%: ${hits} • Серия: ${currentStreak} (макс: ${maxStreak})`;
    };

    // ===== State =====
    let state = load();
    normalizeFirstDate();
    ensureDayRollover();
    save();
    render();

    // ===== Main actions =====
    const addWater = (ml) => {
      ensureDayRollover();
      state.todayMl = Math.max(0, state.todayMl + ml);
      save();
      render();
      haptic(12);
    };

    const removeGlass = () => {
      ensureDayRollover();
      state.todayMl = Math.max(0, state.todayMl - state.glassMl);
      save();
      render();
      haptic(8);
    };

    els.plusBtn.addEventListener("click", () => addWater(state.glassMl));
    els.minusBtn.addEventListener("click", removeGlass);

    // ===== Custom Add =====
    const openCustom = () => {
      els.customMlInput.value = "";
      openModal(els.customModal);
      els.customMlInput.focus();
    };

    const closeCustom = () => closeModal(els.customModal);

    // FIX: пустое/NaN не превращается в 50 ml
    const saveCustom = () => {
      const raw = parseFloat(els.customMlInput.value);
      if (!Number.isFinite(raw)) return;

      const ml = clamp(Math.round(raw), 50, 5000);
      if (ml > 0) {
        addWater(ml);
        closeCustom();
      }
    };

    els.customBtn.addEventListener("click", openCustom);
    els.customClose.addEventListener("click", closeCustom);
    els.customCancel.addEventListener("click", closeCustom);
    els.customSave.addEventListener("click", saveCustom);
    els.customModal.addEventListener("click", (ev) => onOverlayClickToClose(els.customModal, ev));

    els.customMlInput.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") saveCustom();
    });

    // ===== Settings =====
    let draftSettings = null;

    const openSettings = () => {
      ensureDayRollover();
      draftSettings = {
        weightKg: state.weightKg,
        glassMl: state.glassMl,
        customGoal: state.customGoal,
      };

      els.weightInput.value = String(draftSettings.weightKg);
      els.glassInput.value = String(draftSettings.glassMl);
      els.customGoalInput.value = draftSettings.customGoal > 0 ? String(draftSettings.customGoal) : "";

      els.settingsGoal.textContent = `${calcGoalMl(draftSettings.weightKg, draftSettings.customGoal)} мл/день`;
      openModal(els.settingsModal);
    };

    const closeSettings = () => {
      draftSettings = null;
      closeModal(els.settingsModal);
    };

    // FIX: пустые поля не затирают настройки в минимумы; пустая ручная цель = 0 (сброс)
    const saveSettings = () => {
      const wRaw = parseFloat(els.weightInput.value);
      const gRaw = parseFloat(els.glassInput.value);
      const cgRaw = parseFloat(els.customGoalInput.value);

      const w = Number.isFinite(wRaw) ? clamp(wRaw, 20, 250) : state.weightKg;
      const g = Number.isFinite(gRaw) ? clamp(Math.round(gRaw), 50, 2000) : state.glassMl;
      const cg = Number.isFinite(cgRaw) ? clamp(Math.round(cgRaw), 0, 10000) : 0;

      state.weightKg = w;
      state.glassMl = g;
      state.customGoal = cg;

      save();
      render();
      closeSettings();
      haptic([8, 18, 8]);
    };

    els.settingsBtn.addEventListener("click", openSettings);
    els.settingsClose.addEventListener("click", closeSettings);
    els.settingsCancel.addEventListener("click", closeSettings);
    els.settingsSave.addEventListener("click", saveSettings);
    els.settingsModal.addEventListener("click", (ev) => onOverlayClickToClose(els.settingsModal, ev));

    const updateDraftGoal = () => {
      const wRaw = parseFloat(els.weightInput.value);
      const cgRaw = parseFloat(els.customGoalInput.value);

      const w = Number.isFinite(wRaw) ? clamp(wRaw, 20, 250) : state.weightKg;
      const cg = Number.isFinite(cgRaw) ? clamp(Math.round(cgRaw), 0, 10000) : 0;

      els.settingsGoal.textContent = `${calcGoalMl(w, cg)} мл/день`;
    };

    els.weightInput.addEventListener("input", updateDraftGoal);
    els.customGoalInput.addEventListener("input", updateDraftGoal);

    // ===== Stats =====
    const openStats = () => {
      renderStats();
      openModal(els.statsModal);
    };

    const closeStats = () => closeModal(els.statsModal);

    els.statsBtn.addEventListener("click", openStats);
    els.statsClose.addEventListener("click", closeStats);
    els.statsModal.addEventListener("click", (ev) => onOverlayClickToClose(els.statsModal, ev));

    els.resetToday.addEventListener("click", () => {
      ensureDayRollover();
      const ok = confirm("Сбросить выпитое за сегодня? Это не удалит историю.");
      if (!ok) return;
      state.todayMl = 0;
      save();
      render();
      renderStats();
      haptic([10, 40, 10]);
    });

    els.resetAll.addEventListener("click", () => {
      const ok = confirm("Сбросить все данные? Это удалит историю, настройки и статистику.");
      if (!ok) return;
      state = defaults();
      save();
      render();
      renderStats();
      haptic([12, 30, 12, 30, 12]);
    });

    // ===== Keyboard (Esc) =====
    window.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") {
        if (isOpen(els.statsModal)) closeStats();
        if (isOpen(els.settingsModal)) closeSettings();
        if (isOpen(els.customModal)) closeCustom();
      }
    });

    // ===== Parallax / Depth (mouse + deviceorientation) =====
    const setParallax = (nx, ny) => {
      const px = clamp(nx, -1, 1) * 10;
      const py = clamp(ny, -1, 1) * 10;
      document.documentElement.style.setProperty("--parx", `${px}px`);
      document.documentElement.style.setProperty("--pary", `${py}px`);
      document.documentElement.style.setProperty("--tilt", `${(-nx * 0.6).toFixed(2)}deg`);
    };

    window.addEventListener(
      "mousemove",
      (ev) => {
        const w = window.innerWidth || 1;
        const h = window.innerHeight || 1;
        const nx = (ev.clientX / w) * 2 - 1;
        const ny = (ev.clientY / h) * 2 - 1;
        setParallax(nx, ny);
      },
      { passive: true }
    );

    const attachDeviceOrientation = () => {
      window.addEventListener(
        "deviceorientation",
        (ev) => {
          const gamma = Number.isFinite(ev.gamma) ? ev.gamma : 0;
          const beta = Number.isFinite(ev.beta) ? ev.beta : 0;

          const nx = clamp(gamma / 35, -1, 1);
          const ny = clamp(beta / 45, -1, 1);
          setParallax(nx, ny);
        },
        { passive: true }
      );
    };

    const maybeEnableMotion = async () => {
      try {
        if (
          typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res === "granted") attachDeviceOrientation();
        } else {
          attachDeviceOrientation();
        }
      } catch {
        // ignore
      }
    };

    const once = { once: true, passive: true };
    window.addEventListener("pointerdown", maybeEnableMotion, once);
    window.addEventListener("touchstart", maybeEnableMotion, once);

    // ===== Midnight safety check =====
    setInterval(() => {
      const before = state.lastDate;
      ensureDayRollover();
      if (state.lastDate !== before) {
        render();
        if (isOpen(els.statsModal)) renderStats();
      }
    }, 30_000);
  })();
</script>

  </body>
</html>

